# Plant Care 작업 내역 (2026-01-17)

## 개요
Plant Care 랜딩 페이지의 Firebase 인증 및 리뷰 시스템 관련 수정 작업

---

## 1. 배포 정보

### Vercel 배포
- **배포 URL**: `https://landing01-iota.vercel.app`
- **GitHub 저장소**: `https://github.com/kjs369369/testlanding.git`
- **브랜치**: `master`
- **자동 배포**: GitHub push 시 자동으로 Vercel에 배포됨

### 배포 방법
```bash
# 변경사항 커밋 및 푸시
git add .
git commit -m "커밋 메시지"
git push origin master
```

---

## 2. Firebase 도메인 인증 설정

### 문제
Google 로그인 시 다음 오류 발생:
```
Firebase: This domain is not authorized for OAuth operations for your Firebase project.
(auth/unauthorized-domain)
```

### 해결 방법
1. [Firebase Console](https://console.firebase.google.com) 접속
2. 프로젝트 선택
3. **Authentication** → **Settings** → **Authorized domains** 이동
4. **Add domain** 클릭
5. `landing01-iota.vercel.app` 추가
6. 저장

### 승인된 도메인 목록 (필수)
- `localhost` (개발용)
- `landing01-iota.vercel.app` (프로덕션)

---

## 3. 로그인 플로우 구현

### 핵심 동작
- Google/이메일 로그인 성공 시 → 메인 페이지(`index.html`)로 이동
- 로그인 상태는 localStorage와 Firebase Auth로 유지
- 이미 로그인된 상태로 로그인/회원가입 페이지 접근 시 → 메인 페이지로 리다이렉트

### 리다이렉트 루프 방지 코드

#### login.html
```javascript
let isLoggingIn = false; // 로그인 진행 중 플래그

window.addEventListener('load', () => {
  initializeFirebase();

  onAuthStateChanged((user) => {
    // 로그인 진행 중이면 리다이렉트하지 않음
    if (user && !isLoggingIn) {
      saveUserToLocalStorage(userData);
      window.location.href = 'index.html';
    }
  });

  document.getElementById('googleLoginBtn').addEventListener('click', () => {
    isLoggingIn = true; // 플래그 설정 후 로그인 시작
    handleGoogleLogin();
  });
});
```

#### signup.html
```javascript
let isSigningUp = false; // 회원가입 진행 중 플래그

// 동일한 패턴으로 구현
```

### localStorage 데이터 구조
```javascript
localStorage.setItem('plantcare_user', JSON.stringify({
  uid: userData.uid,
  name: userData.name,
  email: userData.email,
  picture: userData.picture,
  isLoggedIn: true,
  loginDate: new Date().toISOString()
}));
```

---

## 4. 리뷰 표시 버그 수정

### 문제
`getAverageRating()` 함수가 이미 문자열로 `average`를 반환하는데, `toFixed(1)`을 호출하여 오류 발생

### firebase-config.js의 반환 형태
```javascript
async function getAverageRating(productType = 'pro') {
  // ...
  return {
    average: (total / snapshot.size).toFixed(1),  // 이미 문자열!
    count: snapshot.size
  };
}
```

### 수정 전 (index.html)
```javascript
document.getElementById('averageRating').textContent = ratingData.average.toFixed(1);
renderStars('averageStars', ratingData.average);
```

### 수정 후 (index.html)
```javascript
document.getElementById('averageRating').textContent = ratingData.average;
document.getElementById('totalReviewCount').textContent = ratingData.count;
renderStars('averageStars', parseFloat(ratingData.average));
```

---

## 5. Firebase 리뷰 시스템

### Firestore 컬렉션 구조
```
reviews/
  ├── {reviewId}/
  │   ├── productType: "pro" | "basic"
  │   ├── rating: 1-5
  │   ├── title: string
  │   ├── content: string
  │   ├── userName: string
  │   ├── userPhoto: string (optional)
  │   ├── isApproved: boolean
  │   └── createdAt: timestamp
```

### 리뷰 가져오기 함수
```javascript
// 승인된 리뷰만 가져오기
async function getReviews(productType = 'pro', limitCount = 20) {
  const snapshot = await db.collection('reviews')
    .where('productType', '==', productType)
    .where('isApproved', '==', true)
    .get();

  const reviews = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  // 최신순 정렬
  reviews.sort((a, b) => {
    const dateA = a.createdAt?.toDate?.() || new Date(0);
    const dateB = b.createdAt?.toDate?.() || new Date(0);
    return dateB - dateA;
  });

  return reviews.slice(0, limitCount);
}

// 평균 평점 가져오기
async function getAverageRating(productType = 'pro') {
  const snapshot = await db.collection('reviews')
    .where('productType', '==', productType)
    .where('isApproved', '==', true)
    .get();

  if (snapshot.empty) {
    return { average: "0.0", count: 0 };
  }

  let total = 0;
  snapshot.forEach(doc => {
    total += doc.data().rating || 0;
  });

  return {
    average: (total / snapshot.size).toFixed(1),
    count: snapshot.size
  };
}
```

---

## 6. 주요 파일 구조

```
landing01/
├── index.html          # 메인 랜딩 페이지 (리뷰 표시, 인증 상태 UI)
├── login.html          # 로그인 페이지
├── signup.html         # 회원가입 페이지
├── mypage.html         # 마이페이지
├── pricing-pro.html    # 프로 플랜 페이지
├── firebase-config.js  # Firebase 설정 및 함수
├── vercel.json         # Vercel 배포 설정
└── docs/               # 문서 폴더
    └── 2026-01-17-작업내역.md
```

---

## 7. 체크리스트

### 배포 전 확인사항
- [ ] Firebase Console에서 도메인 인증 확인
- [ ] Google Cloud Console에서 OAuth 리디렉션 URI 확인
- [ ] 코드 변경사항 커밋 완료
- [ ] `git push origin master` 실행

### 기능 테스트
- [ ] Google 로그인 → 메인 페이지 이동
- [ ] 이메일 로그인 → 메인 페이지 이동
- [ ] 로그인 상태 유지 (새로고침 후)
- [ ] 리뷰 섹션에 실제 데이터 표시
- [ ] 평균 평점 및 별점 표시

---

## 8. 트러블슈팅

### Google 로그인이 안 될 때
1. Firebase Console → Authentication → Settings → Authorized domains 확인
2. Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client IDs 확인
3. 브라우저 콘솔에서 오류 메시지 확인

### 리뷰가 표시되지 않을 때
1. Firestore에 리뷰 데이터가 있는지 확인
2. `isApproved: true`인 리뷰가 있는지 확인
3. `productType`이 올바른지 확인 (기본값: 'pro')
4. 브라우저 콘솔에서 오류 확인

### 로그인 후 리다이렉트 루프
- `isLoggingIn` / `isSigningUp` 플래그가 제대로 설정되어 있는지 확인
- `onAuthStateChanged` 콜백에서 플래그 체크 로직 확인

---

## 9. 커밋 히스토리

```bash
# 오늘 작업 관련 커밋
git log --oneline -5

# 예시:
# abc1234 Fix review average rating display
# def5678 Add auth state UI in header
# ...
```

---

## 10. 참고 링크

- [Firebase Console](https://console.firebase.google.com)
- [Vercel Dashboard](https://vercel.com/dashboard)
- [Firebase Auth Documentation](https://firebase.google.com/docs/auth)
- [Firestore Documentation](https://firebase.google.com/docs/firestore)
